#!/usr/bin/env ruby

require "proweb"

project_ids = Proweb.config["project_ids"]

Proweb.connect

acs = Proweb::AttributeCategories.new(
  Proweb.config['files']['attribute_categories']
)

attribs = Proweb::Project.where(:id => project_ids).map do |project|
  project.pw_attributes.where(:attribute_kind_id => 43).all
end.flatten.uniq


headers = [
  "attribute_id",
  "usage_count"
]

headers += project_ids.map{|id| "usage_count_project_#{id}"}
headers += [
  'category_1', 'translation_1', 'translation_2', 'translation_3'
]

puts headers.join("|")

attribs.each do |a|
  if a.translations.any?{|t| t.name.match(/\n/m)}
    STDERR.puts "ID: #{a.id}: NEWLINES"
    next
  end

  names = a.translations.map{|t| t.name}
  names += [""] until names.size == 3

  results = [a.id] + [a.objects.count]
  results += project_ids.map{|id|
    a.objects.where(:project_id => id).count
  }
  results += [acs.for_attribute_id(a.id)] + names
  puts results.join("|")
end
